# 第11回 相関と単回帰分析 {.unnumbered}

![相関と単回帰分析](figure/11_regression_1/infographic.png)

## 未来を予測する魔法

「もっと勉強したら、成績はどれくらい上がる？」
「気温が1度上がったら、ビールは何本多く売れる？」

もし、あるデータ ($X$) を知ることで、未知のデータ ($Y$) を**予測**できるとしたら？
それはビジネスでも科学でも、最強の武器になる。

今回は、2つのデータの関係性を読み解き、未来を予測するための数理モデル **単回帰分析** を習得しよう。

## 1. 2人のダンス：相関 (Correlation)

予測の第一歩は、「2つのデータに関係があるか？」を知ること。
これを**相関**と呼ぶ。

イメージしてほしい。2人のダンサーが踊っている。
片方が右に動いたとき、もう片方も必ず右に動くなら、2人の息はピッタリだ（強い正の相関）。
バラバラに動いているなら、関係はない（無相関）。

この「息の合い具合」を数値化したのが **相関係数 $r$** 。

-   **$r = 1$**: 完全なシンクロ（正）。
-   **$r = -1$**: 正反対の動き（負）。
-   **$r = 0$**: 全くの無関係。

### 実践: 支払額とチップの関係

「支払額 ($X$) が多い客ほど、チップ ($Y$) も多く払うのか？」を確認してみよう。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)

# 相関係数の算出
cor(tips$total_bill, tips$tip)

# 検定: その相関は偶然ではないか？
cor.test(tips$total_bill, tips$tip)
```

結果は $r \approx 0.68$。
「かなり息が合っている（強い正の相関）」と言える。支払額が増えれば、チップも増える傾向がはっきりとある。

## 2. 予測マシンを作る：単回帰分析

相関があることが分かったら、次は具体的に予測をする。
「支払いが10ドル増えたら、チップは**いくら**増えるの？」

この問いに答えるために、データの真ん中を貫く「運命の赤い糸（回帰直線）」を引く。
この直線の式が、私たちの**予測マシン**になる。

$$ \text{予測値} = \text{切片} + \text{傾き} \times \text{支払額} $$

### 交換レートとしての「傾き」

ここで最も重要なのが **傾き ($\beta_1$)** 。
これは、$X$ と $Y$ の**交換レート**のようなもの。
「支払額を1ドル投入すると、チップが何ドル返ってくるか？」を表す。

```{r}
# 予測モデルの作成
model <- lm(tip ~ total_bill, data = tips)
summary(model)
```

**解析結果**:
-   **傾き (Estimate of total_bill)**: `0.105`

これは、**「支払額が1ドル増えるごとに、チップは約10.5セント増える」** という法則を表している。
これさえ分かれば、まだ見ぬ客のチップ額も予測できる。

### 直線の可視化

```{r}
ggplot(tips, aes(x = total_bill, y = tip)) +
  theme_gray(base_family = "HiraKakuProN-W3") + # [対象注意] Mac用設定
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  labs(title = "予測マシン（回帰直線）の可視化")
```

赤い線が、推定された予測モデルだ。

## 3. モデルの品質チェック：残差診断

モデルを作って終わりではない。
「この予測マシンは本当に優秀か？」をチェックする必要がある。

注目するのは、予測と実測のズレ、すなわち **残差 (Residuals)** 。
完璧なモデルなら、残差は単なる「ランダムなノイズ」になる。もし残差に何らかのパターン（癖）が残っていたら、モデルはまだ何か重要な情報を見落としていることになる。

### 決定係数 ($R^2$): 説明力

まず、このモデルがデータのバラつきの何％を説明できたかを確認する。

-   **Multiple R-squared**: `0.4566`
    -   「チップの変動の約46%は、支払額の違いで説明できる」
    -   残りの54%は、支払額以外の要因（客の気前の良さや接客態度など）。

### 残差の健康診断

モデル変な癖がないか、レントゲン（残差プロット）を撮って確認する。

```{r}
# 予測値と残差の準備
tips_aug <- tips %>%
  mutate(pred = predict(model), resid = residuals(model))

# 1. 残差プロット（クセがないか？）
p1 <- ggplot(tips_aug, aes(x = pred, y = resid)) +
  theme_gray(base_family = "HiraKakuProN-W3") + # [対象注意] Mac用設定
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "残差の散らばり")

# 2. Q-Qプロット（正規分布しているか？）
p2 <- ggplot(tips_aug, aes(sample = resid)) +
  theme_gray(base_family = "HiraKakuProN-W3") + # [対象注意] Mac用設定
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "残差の正規性")

# 並べて表示
p1
p2
```

*   **残差プロット**: 0の周りにバランスよく散らばっていれば合格。
*   **Q-Qプロット**: 赤い線の上に並んでいれば合格。

## 課題

1.  **単回帰分析の実践**:
    `tips` データを用いて、`size`（客数）を説明変数、$Y=$ `total_bill`（支払総額）を被説明変数とする単回帰分析を行ってください。
    得られた傾き $\hat{\beta}_1$ の値を解釈し、その統計的有意性について述べてください。

## 練習問題

### 練習1: 相関の罠
架空のデータにおいて、「アイスクリームの売上」と「水難事故の件数」に強い正の相関が見られました。
これは「アイスクリームを食べることが水難事故の原因である」ことを意味しますか？第三の要因（交絡因子）を挙げて説明してください。

### 練習2: 決定係数の解釈
ある回帰モデルの決定係数が $R^2 = 0.05$ でしたが、傾きの検定は $p < 0.001$ で有意でした。
この結果はどう解釈すべきですか？「モデルは無意味」ですか、それとも「関係はあるが予測精度は低い」ですか？

### 練習3: 残差のパターン
残差プロットにおいて、残差がU字型のパターンを描いていました。これはモデルの何の仮定に違反している可能性が高いですか？（ヒント：線形性）

## まとめ

| 概念 | アナロジー | 意味 |
|---|---|---|
| **相関** | ダンスのシンクロ率 | 2つの変数の動きの連動性。 |
| **回帰直線** | 予測マシン | $X$ から $Y$ を弾き出す数式。 |
| **傾き ($\beta_1$)** | 交換レート | $X$ が1増えると $Y$ がどれだけ増えるか。 |
| **残差** | 削りカス | モデルが説明しきれなかったノイズ。 |
| **決定係数 ($R^2$)** | テストの点数 | モデルがどれくらい優秀かのスコア (0-1)。 |
