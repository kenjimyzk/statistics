# 第11回 相関と単回帰分析 {.unnumbered}

## 今回の目標

-   相関係数を計算し、2変数の関係の強さを理解する。
-   単回帰分析を行い、結果（切片、傾き）を解釈する。
-   回帰分析の仮定と診断を学ぶ。

## 相関 (Correlation)

2つの変数の間に、直線的な関係があるかどうかを表す指標です。
相関係数 $r$ は $-1 \le r \le 1$ の値をとり、1に近いほど正の相関、-1に近いほど負の相関、0に近いほど無相関を表します。

### 相関係数の計算

$$r = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i - \bar{x})^2 \sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

`tips` データの `total_bill` と `tip` の相関係数を計算してみましょう。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)

cor(tips$total_bill, tips$tip)
```

### 相関係数の解釈

| 相関係数の絶対値 | 解釈 |
|-----------------|------|
| 0.0 - 0.2 | ほぼ相関なし |
| 0.2 - 0.4 | 弱い相関 |
| 0.4 - 0.7 | 中程度の相関 |
| 0.7 - 1.0 | 強い相関 |

### 相関行列

複数の変数間の相関を一度に確認できます。

```{r}
# 数値変数だけを選んで相関行列を作成
tips %>%
  select(total_bill, tip, size) %>%
  cor()
```

### 相関係数の検定

相関係数が0と有意に異なるかを検定できます。

```{r}
cor.test(tips$total_bill, tips$tip)
```

## 単回帰分析 (Simple Linear Regression)

ある変数 $x$（説明変数）を使って、別の変数 $y$（被説明変数）を予測・説明するモデルを作ります。

$$ y = \beta_0 + \beta_1 x + \epsilon $$

-   $\beta_0$: 切片 (Intercept)
-   $\beta_1$: 傾き (Slope)
-   $\epsilon$: 誤差項

Rでは `lm()` 関数（Linear Model）を使います。
「支払総額 ($x$) が増えると、チップ ($y$) はどれくらい増えるか？」を分析します。

```{r}
model <- lm(tip ~ total_bill, data = tips)
summary(model)
```

### 結果の解釈

`Coefficients:` の部分を見ます。

```
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) 0.920270   0.159735   5.761 2.53e-08 ***
total_bill  0.105025   0.007365  14.260  < 2e-16 ***
```

-   `(Intercept)` の Estimate: `0.92`
    -   切片です。$x$（支払総額）が0のときの $y$（チップ）の予測値です。
    -   ただし、支払総額が0ドルということは現実にはあり得ないので、この値自体に深い意味はないことが多いです。
-   `total_bill` の Estimate: `0.105`
    -   傾きです。これが最も重要な数値です。
    -   **「支払総額が1ドル増えると、チップは約0.105ドル（約10.5セント）増える傾向がある」** と解釈します。
-   `Pr(>|t|)`:
    -   `total_bill` の行を見ると `< 2e-16` となっています。これは $2 \times 10^{-16}$ 未満という非常に小さな値です。
    -   0.05よりはるかに小さいため、「傾きは0ではない（支払総額とチップには統計的に有意な関係がある）」と結論づけられます。

### 散布図に回帰直線を引く

`ggplot2` で `geom_smooth(method = "lm")` を使うと、簡単に回帰直線を追加できます。

```{r}
ggplot(tips, aes(x = total_bill, y = tip)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_point() +
  geom_smooth(method = "lm", color = "red")
```



### 残差プロット

回帰分析がうまくいっているか確認するために、予測値と残差（予測とのズレ）の関係を見ることがあります。

```{r}
# データフレームに予測値と残差を追加 {.unnumbered}
tips_aug <- tips %>%
  mutate(pred = predict(model), resid = residuals(model))

ggplot(tips_aug, aes(x = pred, y = resid)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "残差プロット", x = "予測値", y = "残差")
```

良い回帰モデルでは：
- 残差が0の周りにランダムに散らばっている
- 残差にパターンがない（扇形になっていない等）

## 決定係数 (R-squared)

回帰モデルがデータをどれくらい説明できているかを表す指標です。

$$R^2 = 1 - \frac{\sum(y_i - \hat{y}_i)^2}{\sum(y_i - \bar{y})^2}$$

- $R^2 = 0$: モデルは全く説明力がない
- $R^2 = 1$: モデルはデータを完全に説明できる

```{r}
# summaryから決定係数を確認
summary(model)$r.squared
```

今回のモデルでは約0.46、つまりチップの変動の約46%を支払総額で説明できています。

## 回帰分析の仮定

回帰分析が正しく機能するためには、いくつかの仮定が必要です：

1. **線形性**: $x$ と $y$ の関係が線形である
2. **独立性**: 観測値が互いに独立
3. **等分散性**: 残差の分散が一定
4. **正規性**: 残差が正規分布に従う

### 仮定の診断

```{r}
# 残差の正規性を確認（Q-Qプロット）
ggplot(tips_aug, aes(sample = resid)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "残差のQ-Qプロット")
```

## 課題

1.  `tips` データを使って、`size`（人数）を説明変数、`total_bill`（支払総額）を被説明変数とする単回帰分析を行ってください。
    人数が1人増えると、支払総額は何ドル増えると推定されますか？

## 練習問題

### 練習1: 相関分析
`mtcars` データ（Rに組み込み済み）を使って：
1. `mpg`（燃費）と `wt`（重量）の相関係数を計算
2. 相関係数の検定を行い、有意かどうか判断
3. 散布図を作成

### 練習2: 単回帰分析
`mtcars` データを使って、`wt` を説明変数、`mpg` を被説明変数とする単回帰分析を行ってください：
1. モデルを作成し、係数を解釈
2. 決定係数を確認
3. 回帰直線付きの散布図を作成

### 練習3: 残差診断
練習2のモデルについて：
1. 残差プロットを作成
2. Q-Qプロットを作成
3. モデルの仮定が満たされているか評価

## 回帰分析のまとめ

| 用語 | 説明 |
|------|------|
| 被説明変数（目的変数）| 予測したい変数 $y$ |
| 説明変数（予測変数）| 予測に使う変数 $x$ |
| 切片 | $x = 0$ のときの $y$ の値 |
| 傾き | $x$ が1単位増えたときの $y$ の変化量 |
| 残差 | 実測値と予測値の差 |
| 決定係数 | モデルの説明力（0〜1）|
