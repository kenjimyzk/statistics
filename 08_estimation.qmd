# 第8回 統計的推定 {.unnumbered}

## 今回の目標

-   点推定と区間推定の違いを理解する。
-   信頼区間の意味を正しく理解する。
-   Rで信頼区間を計算する。

## 推定とは

推定とは、標本のデータから母集団のパラメータ（母数）を推測することです。

### 良い推定量の性質

1. **不偏性**: 推定量の期待値が真の値に等しい（$E[\hat{\theta}] = \theta$）
2. **一致性**: サンプルサイズが大きくなると真の値に近づく
3. **効率性**: 分散が小さい（ばらつきが少ない）

## 点推定 (Point Estimation)

母数（母平均など）を一つの値でピンポイントに推定することです。
例えば、標本平均 $\bar{x}$ は母平均 $\mu$ の点推定値として使われます。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)

# 点推定
mean(tips$total_bill)  # 母平均の点推定
```

### 点推定の限界

点推定だけでは、その推定がどれくらい信頼できるか分かりません。そこで区間推定が必要になります。

## 区間推定 (Interval Estimation)

母数が含まれるであろう「範囲」を、ある確率（信頼係数）をもって推定することです。
一般的に **95%信頼区間** がよく使われます。

### 信頼区間の意味

「95%の確率で母数がこの区間に入る」というのは少し不正確です。
正しくは、「同じ手順で標本抽出と区間推定を100回繰り返したら、そのうち約95回の区間には母数が含まれる」という意味です。

これをシミュレーションで可視化してみましょう。

```{r}
library(tidyverse)
set.seed(123)

# シミュレーション設定 {.unnumbered}
n_sim <- 100
n_sample <- 30
mu <- 50
sigma <- 10

# 結果を格納するデータフレーム {.unnumbered}
results <- data.frame(id = 1:n_sim, lower = NA, upper = NA, hit = NA)

for (i in 1:n_sim) {
  # 標本抽出
  x <- rnorm(n_sample, mean = mu, sd = sigma)
  # t検定で信頼区間を計算
  test <- t.test(x)
  results$lower[i] <- test$conf.int[1]
  results$upper[i] <- test$conf.int[2]
  # 母平均が含まれているか判定
  results$hit[i] <- (mu >= results$lower[i] & mu <= results$upper[i])
}

# プロット {.unnumbered}
ggplot(results, aes(x = id, ymin = lower, ymax = upper, color = hit)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_errorbar(width = 0.5) +
  geom_hline(yintercept = mu, linetype = "dashed") +
  labs(title = "95%信頼区間のシミュレーション (100回)", x = "試行回数", y = "推定された区間") +
  scale_color_manual(values = c("TRUE" = "gray", "FALSE" = "red"))
```

## 母平均の信頼区間（母分散が未知の場合）

t分布を使って計算します。Rでは `t.test()` 関数を使うと簡単に計算できます。
`tips` データの `total_bill` の平均値の95%信頼区間を求めてみましょう。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)

t.test(tips$total_bill)
```

出力結果の `95 percent confidence interval:` の部分を見ます。

```
95 percent confidence interval:
 18.66333 20.90855
```

これは、「支払総額の母平均は、約18.66ドルから20.91ドルの間にあると考えられる」ことを示しています。

### 信頼区間の幅に影響する要因

1. **信頼係数**: 信頼係数を上げる（95%→99%）と、区間は広くなる
2. **サンプルサイズ**: サンプルサイズが大きいほど、区間は狭くなる
3. **データのばらつき**: 標準偏差が大きいほど、区間は広くなる

```{r}
# 信頼係数を変えた比較
ci_90 <- t.test(tips$total_bill, conf.level = 0.90)$conf.int
ci_95 <- t.test(tips$total_bill, conf.level = 0.95)$conf.int
ci_99 <- t.test(tips$total_bill, conf.level = 0.99)$conf.int

data.frame(
  信頼係数 = c("90%", "95%", "99%"),
  下限 = c(ci_90[1], ci_95[1], ci_99[1]),
  上限 = c(ci_90[2], ci_95[2], ci_99[2]),
  幅 = c(ci_90[2] - ci_90[1], ci_95[2] - ci_95[1], ci_99[2] - ci_99[1])
)
```

## t分布

母分散が未知の場合（通常はこのケース）、正規分布ではなく**t分布**を使います。

t分布は正規分布に似ていますが、裾が厚い（外れ値が出やすい）特徴があります。
サンプルサイズが大きくなると、正規分布に近づきます。

```{r}
# t分布と正規分布の比較
x <- seq(-4, 4, length.out = 100)
df_dist <- data.frame(
  x = rep(x, 3),
  y = c(dnorm(x), dt(x, df = 3), dt(x, df = 30)),
  分布 = rep(c("正規分布", "t分布 (df=3)", "t分布 (df=30)"), each = length(x))
)

ggplot(df_dist, aes(x = x, y = y, color = 分布)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_line(size = 1) +
  labs(title = "t分布と正規分布の比較")
```

## 母比率の信頼区間

「支持率」や「喫煙率」などの割合（比率）の推定には `prop.test()` を使います。
例：100人中60人が賛成した場合の、母集団での賛成率の95%信頼区間。

```{r}
prop.test(x = 60, n = 100)
```

## 課題

1.  `tips` データの `tip`（チップ）について、平均値の99%信頼区間を求めてください。
    （ヒント: `t.test()` の引数に `conf.level = 0.99` を指定します）

## 練習問題

### 練習1: 信頼区間の計算
1. `tips` データの `size`（人数）の95%信頼区間を計算してください
2. 90%信頼区間と99%信頼区間も計算し、幅を比較してください

### 練習2: サンプルサイズの影響
1. `tips` データから50件をランダムに抽出し、`total_bill` の95%信頼区間を計算
2. 100件、200件でも同様に計算
3. サンプルサイズと信頼区間の幅の関係を確認

```{r}
#| eval: false
# ヒント
sample_data <- tips[sample(nrow(tips), 50), ]
t.test(sample_data$total_bill)
```

### 練習3: 母比率の信頼区間
`tips` データで、喫煙者の割合の95%信頼区間を求めてください。

```{r}
#| eval: false
# ヒント: 喫煙者の数と全体の数を使う
smokers <- sum(tips$smoker == "Yes")
total <- nrow(tips)
prop.test(smokers, total)
```

## 推定のまとめ

| 推定の種類 | 説明 | 例 |
|-----------|------|-----|
| 点推定 | 1つの値で推定 | $\bar{x} = 19.8$ |
| 区間推定 | 範囲で推定 | $[18.7, 20.9]$ |

| 信頼区間の種類 | R関数 | 用途 |
|---------------|-------|------|
| 母平均の信頼区間 | `t.test()` | 連続変数の平均 |
| 母比率の信頼区間 | `prop.test()` | 割合・比率 |
