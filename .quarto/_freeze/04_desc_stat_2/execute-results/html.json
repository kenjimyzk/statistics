{
  "hash": "534776e4c498b6948c3bac48535d56b3",
  "result": {
    "engine": "knitr",
    "markdown": "# 第4回 記述統計 (2) データの可視化 {.unnumbered}\n\n![データの可視化](figure/04_desc_stat_2/infographic.png)\n\n## 要約の限界と「アンスコムの警鐘」\n\n前節では、膨大なデータを「平均値」や「分散」などの数値に縮約し、全体の特徴を掴みました。\nしかし、縮約には副作用があります。「形の消失」です。\n\nAnscombe (1973) の有名な例、アンスコムのカルテットを見てみましょう。\n一見、平均値も分散も相関係数もしっかり一致している4つのデータセットです。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n# Rに標準で入っている anscombe データを整形\nanscombe_long <- anscombe %>%\n  pivot_longer(everything(),\n               names_to = c(\".value\", \"set\"),\n               names_pattern = \"(.)(.)\")\n\n# 統計量を確認：どれもほぼ同じ\nanscombe_long %>%\n  group_by(set) %>%\n  summarize(\n    mean_x = mean(x), mean_y = mean(y),\n    sd_x = sd(x), sd_y = sd(y),\n    cor = cor(x, y)\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"set\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"mean_x\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"mean_y\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sd_x\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sd_y\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"cor\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"9\",\"3\":\"7.500909\",\"4\":\"3.316625\",\"5\":\"2.031568\",\"6\":\"0.8164205\"},{\"1\":\"2\",\"2\":\"9\",\"3\":\"7.500909\",\"4\":\"3.316625\",\"5\":\"2.031657\",\"6\":\"0.8162365\"},{\"1\":\"3\",\"2\":\"9\",\"3\":\"7.500000\",\"4\":\"3.316625\",\"5\":\"2.030424\",\"6\":\"0.8162867\"},{\"1\":\"4\",\"2\":\"9\",\"3\":\"7.500909\",\"4\":\"3.316625\",\"5\":\"2.030579\",\"6\":\"0.8165214\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n数値だけなら「これらは同じ性質のデータだ」と結論づけてしまうでしょう。でも、グラフにして可視化した瞬間、景色は一変します。\n[対象注意: 日本語フォント設定は環境依存あり]\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(anscombe_long, aes(x = x, y = y)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point() +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  facet_wrap(~set) +\n  labs(title = \"数値は嘘をつかないが、真実を語るとは限らない\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nきれいな直線、曲線、外れ値の影響...。数値要約で捨て去られた情報が、可視化ではっきりと浮かび上がりました。\nデータ分析において、可視化は分析の「後」の飾りではありません。分析の「最初」に行うべき、欠かせない診断です。\n\n## 準備\n\n本節でも `tips` データセット（Bryant & Smith, 1995）を使います。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv\"\ntips <- read_csv(url)\n```\n:::\n\n\n## キャンバスに層を重ねる：ggplot2の思想\n\nRの可視化パッケージ **ggplot2** の設計思想は、Wickham (2010) の \"Layered Grammar of Graphics\"（グラフィックスの層状文法）に基づいています。\nExcelみたいに「棒グラフを作るボタン」があるわけではありません。\n\n> 「データ」という土台に、「座標」を定義し、「点や棒（Geom）」を乗せ、「説明（Labels）」を加える。\n\nこの工程をコードで書きます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = tips, mapping = aes(x = total_bill, y = tip)) + # キャンバスと座標\n  geom_point()                                                # 何を描くか（点）\n```\n:::\n\n\n## 1. 分布の形状を見る\n\nまずは、データが「どんな形」をしているか確認します。\n\n### 山の形を知る：ヒストグラム\n\n連続した数値データ（金額など）が、どこに集まっているかを見に行きます。\n山は一つか、二つか？ 左右対称か、歪んでいるか？\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = total_bill)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_histogram(bins = 30, fill = \"skyblue\", color = \"white\") +\n  labs(title = \"支払総額の分布\", x = \"支払総額 ($)\", y = \"度数\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### 構造を要約する：箱ひげ図\n\nヒストグラムは詳細ですが、複数のグループ比較には不向きです。重なって見づらいから。\nそこで**箱ひげ図**の出番です。分布の情報を「箱」と「ひげ」に要約します。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = day, y = total_bill, fill = day)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_boxplot() +\n  labs(title = \"曜日ごとの支払額の違い\", x = \"曜日\", y = \"支払総額\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n**Tukeyの箱ひげ図の定義**:\n\n-   **箱**: データの中央50%（第1四分位数〜第3四分位数）。この中に「普通」のデータが入ります。\n-   **太線**: 中央値（Median）。\n-   **点**: 箱から `1.5倍の四分位範囲` 以上離れた値。統計的な「外れ値候補」として扱います。\n\n### 分布の機微を見る：バイオリンプロット\n\n箱ひげ図だと「山が2つある」などの情報は消えてしまいます。分布の形状（密度）そのものを表示したい場合は、バイオリン図を使います。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = day, y = total_bill, fill = day)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_violin() +\n  geom_boxplot(width = 0.1, fill = \"white\") + # 箱ひげ図も重ねると最強\n  labs(title = \"分布の形状比較（バイオリン+箱ひげ）\", x = \"曜日\", y = \"支払総額\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## 2. 関係性を探る\n\n次は、2つの変数がどう関わっているかを探ります。\n\n### 2つの量の相関：散布図\n\n「たくさん食べた人は、たくさんチップを払うのか？」\n2つの連続変数（横軸と縦軸）の関係をプロットします。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = total_bill, y = tip)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point(color = \"blue\", alpha = 0.5) +\n  labs(title = \"支払総額とチップの正の相関\", x = \"支払総額\", y = \"チップ\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nここに第3の次元（情報）を加えるのも簡単です。例えば、性別によって色を変えます（`color = sex`）。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = total_bill, y = tip, color = sex)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### 状況ごとの違い：ファセット分割\n\n色分け（color）は便利ですが、情報が増えすぎると「スパゲッティ」のように絡まって読めなくなる。\nそんなときは `facet_wrap()` でグラフ自体を分割してしまいましょう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 喫煙の有無 × 時間帯 で状況を分解する\nggplot(tips, aes(x = total_bill, y = tip)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point(aes(color = smoker)) +\n  facet_wrap(~ time) +\n  labs(title = \"条件による関係性の違い\", x = \"支払総額\", y = \"チップ\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## グラフを「語らせる」ための調整\n\nデフォルトのままでは、グラフは「下書き」です。誰かに伝えるためには、意図が伝わるよう調整します。\n\n### 統計情報の重ね書き\n「傾向」を見せたいなら、生のデータ点だけでなく、平均値や回帰直線を重ねるのが効果的です。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = day, y = total_bill)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_boxplot(fill = \"lightblue\") +\n  stat_summary(fun = mean, geom = \"point\", color = \"red\", size = 3) + # 平均値を赤点で追加\n  stat_summary(fun = mean, geom = \"line\", aes(group = 1), color = \"red\", linetype = \"dashed\") +\n  labs(title = \"曜日ごとの傾向（赤点は平均値）\", x = \"曜日\", y = \"支払総額\")\n```\n\n::: {.cell-output-display}\n![](04_desc_stat_2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n### ユニバーサルデザインへの配慮\nあなたのグラフを見る人の中には、特定の色が見えにくい人（色覚多様性）がいるかもしれません。\n「赤と緑」の色分けだけで情報を伝えてはダメです。形状（`shape`）や線種（`linetype`）の違いを併用するか、誰もが識別しやすいカラーパレット（Viridisなど）の使用をおすすめします。\n\n## 課題\n自分の手で可視化を行い、データからの発見を言語化してください。\n\n1.  `tip`（チップ）の分布をヒストグラムで確認してください。何か気づく特徴はありますか？（キリの良い数字が多い、など）\n2.  `total_bill` と `tip` の散布図を描き、`time`（ランチ/ディナー）で色分けして、時間帯による傾向の違いを議論してください。\n\n## 練習問題\n\n### 練習1: ヒストグラムの最適化\n1. `tip` のヒストグラムを作成してください。\n2. ビンの数（`bins`）を10, 30, 50と変えてみてください。分布の印象がどう変わるか観察してください。\n\n### 練習2: 多変量の可視化\n1. 性別 (`sex`) ごとの `tip` の分布を箱ひげ図で比較してください。女性の方がばらつきが大きいですか？\n2. 喫煙者 (`smoker`) ごとの `total_bill` の分布を、`facet_wrap()` を使って左右に並べて比較してください。\n\n### 練習3: 散布図への情報付加\n1. `total_bill` と `tip` の散布図を作成してください。\n2. 点の大きさを `size`（人数）にマッピングしてください（`aes(size = size)`）。大人数のグループは右上に集まっていますか？\n3. 全体の傾向を示す回帰直線を `geom_smooth()` で追加してください。\n",
    "supporting": [
      "04_desc_stat_2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}