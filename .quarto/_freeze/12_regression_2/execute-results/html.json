{
  "hash": "2b91900a9933c267eeca230d1e94d630",
  "result": {
    "engine": "knitr",
    "markdown": "![重回帰分析と因果推論](./figure/12_regression_2/infographic.png)\n\n# 第12回 重回帰分析と因果推論 {.unnumbered}\n\n## 今回の目標\n\n-   複数の説明変数を使う重回帰分析を理解する。\n-   回帰分析の結果を「因果関係」として解釈する際の注意点（交絡因子など）を学ぶ。\n\n## 重回帰分析 (Multiple Regression)\n\n### 重回帰分析とは\n\n説明変数が2つ以上ある回帰分析を**重回帰分析**といいます。\n\n$$ y = \\beta_0 + \\beta_1 x_1 + \\beta_2 x_2 + \\dots + \\beta_k x_k + \\epsilon $$\n\nここで：\n\n- $y$：被説明変数（目的変数）\n- $x_1, x_2, \\dots, x_k$：説明変数\n- $\\beta_0$：切片\n- $\\beta_1, \\beta_2, \\dots, \\beta_k$：偏回帰係数\n- $\\epsilon$：誤差項\n\n重回帰分析の最大の強みは、「他の条件を一定としたとき（ceteris paribus）」の影響力を推定できることです。これは経済学において非常に重要な概念です。\n\n### 基本的な重回帰分析の例\n\n`tips` データで、チップの額 (`tip`) を、支払総額 (`total_bill`) と人数 (`size`) の両方で説明してみましょう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nurl <- \"https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv\"\ntips <- read_csv(url)\n\nmodel2 <- lm(tip ~ total_bill + size, data = tips)\nsummary(model2)\n#> \n#> Call:\n#> lm(formula = tip ~ total_bill + size, data = tips)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -2.9279 -0.5547 -0.0852  0.5095  4.0425 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 0.668945   0.193609   3.455  0.00065 ***\n#> total_bill  0.092713   0.009115  10.172  < 2e-16 ***\n#> size        0.192598   0.085315   2.258  0.02487 *  \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 1.014 on 241 degrees of freedom\n#> Multiple R-squared:  0.4679,\tAdjusted R-squared:  0.4635 \n#> F-statistic: 105.9 on 2 and 241 DF,  p-value: < 2.2e-16\n```\n:::\n\n\n結果の解釈:\n\n1.  **`total_bill` の係数**: `0.093`\n    -   **「人数 (`size`) を固定したときに（同じ人数のグループ同士で比べたときに）」**、支払総額が1ドル増えると、チップは約0.093ドル増えることを意味します。\n    -   単回帰のとき（0.105）より少し値が小さくなりました。これは、人数という要因をコントロールしたためです。\n2.  **`size` の係数**: `0.193`\n    -   **「支払総額 (`total_bill`) を固定したときに（同じ支払額のグループ同士で比べたときに）」**、人数が1人増えると、チップは約0.193ドル増えることを意味します。\n    -   p値 (`0.02487`) は 0.05 より小さいので、統計的に有意です。つまり、支払額が同じでも、人数が多いほうがチップが多くなる傾向があると言えます。\n\n### 単回帰と重回帰の比較\n\n同じデータで単回帰と重回帰を比較してみましょう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 単回帰モデル\nmodel_simple <- lm(tip ~ total_bill, data = tips)\n\n# 結果の比較\ncat(\"【単回帰】tip ~ total_bill\\n\")\n#> 【単回帰】tip ~ total_bill\ncoef(model_simple)\n#> (Intercept)  total_bill \n#>   0.9202696   0.1050245\n\ncat(\"\\n【重回帰】tip ~ total_bill + size\\n\")\n#> \n#> 【重回帰】tip ~ total_bill + size\ncoef(model2)\n#> (Intercept)  total_bill        size \n#>  0.66894474  0.09271334  0.19259779\n```\n:::\n\n\n`total_bill` の係数が単回帰では約0.105、重回帰では約0.093となっています。この差は、人数（`size`）をコントロールすることで生じたものです。\n\n### 決定係数の比較\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"単回帰のR²:\", summary(model_simple)$r.squared, \"\\n\")\n#> 単回帰のR²: 0.4566166\ncat(\"重回帰のR²:\", summary(model2)$r.squared, \"\\n\")\n#> 重回帰のR²: 0.4678693\n```\n:::\n\n\n説明変数を追加することで、モデルの説明力（$R^2$）が向上していることがわかります。\n\n\n\n### 係数の可視化 (Coefficient Plot)\n\n重回帰分析の結果（推定値と信頼区間）をグラフにすると、どの変数の影響が大きいか分かりやすくなります。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(broom)\n\n# モデルの結果を整理されたデータフレームにする {.unnumbered}\ntidy_model <- tidy(model2, conf.int = TRUE)\ntheme_set(theme_gray(base_family = \"HiraKakuProN-W3\"))\n# 切片(Intercept)を除いてプロット {.unnumbered}\ntidy_model %>%\n  filter(term != \"(Intercept)\") %>%\n  ggplot(aes(x = estimate, y = term)) +\n  geom_point() +\n  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +\n  geom_vline(xintercept = 0, color = \"red\", linetype = \"dashed\") +\n  labs(title = \"重回帰分析の係数プロット (95%信頼区間)\", x = \"推定値\", y = \"説明変数\")\n```\n\n::: {.cell-output-display}\n![](12_regression_2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## ダミー変数を使った回帰分析\n\n### ダミー変数とは\n\nカテゴリ変数（性別、曜日、地域など）を回帰分析に組み込むために使う0/1の変数です。Rでは、カテゴリ変数（factor型）を説明変数にすると、自動的にダミー変数を作成してくれます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 喫煙者かどうかを追加したモデル\nmodel3 <- lm(tip ~ total_bill + size + smoker, data = tips)\nsummary(model3)\n#> \n#> Call:\n#> lm(formula = tip ~ total_bill + size + smoker, data = tips)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -2.8986 -0.5697 -0.0643  0.5115  4.0630 \n#> \n#> Coefficients:\n#>              Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  0.709016   0.204881   3.461 0.000638 ***\n#> total_bill   0.093888   0.009331  10.062  < 2e-16 ***\n#> size         0.180332   0.087803   2.054 0.041077 *  \n#> smokerYes   -0.083433   0.138000  -0.605 0.546028    \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 1.015 on 240 degrees of freedom\n#> Multiple R-squared:  0.4687,\tAdjusted R-squared:  0.462 \n#> F-statistic: 70.57 on 3 and 240 DF,  p-value: < 2.2e-16\n```\n:::\n\n\n`smokerYes` の係数は、非喫煙者（`No`）を基準としたときの喫煙者（`Yes`）の効果を表しています。\n\n### 複数のカテゴリ変数を使う\n\n曜日と時間帯も追加してみましょう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel4 <- lm(tip ~ total_bill + size + smoker + day + time, data = tips)\nsummary(model4)\n#> \n#> Call:\n#> lm(formula = tip ~ total_bill + size + smoker + day + time, data = tips)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -2.8551 -0.5733 -0.0863  0.4866  4.1034 \n#> \n#> Coefficients:\n#>              Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  0.789582   0.346487   2.279   0.0236 *  \n#> total_bill   0.094277   0.009538   9.884   <2e-16 ***\n#> size         0.176374   0.089332   1.974   0.0495 *  \n#> smokerYes   -0.086470   0.146292  -0.591   0.5550    \n#> daySat      -0.125864   0.308524  -0.408   0.6837    \n#> daySun      -0.032578   0.319158  -0.102   0.9188    \n#> dayThur     -0.160946   0.392573  -0.410   0.6822    \n#> timeLunch    0.068146   0.443723   0.154   0.8781    \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 1.022 on 236 degrees of freedom\n#> Multiple R-squared:   0.47,\tAdjusted R-squared:  0.4542 \n#> F-statistic: 29.89 on 7 and 236 DF,  p-value: < 2.2e-16\n```\n:::\n\n\n曜日については、Fri（金曜）が基準カテゴリとなり、他の曜日との差が表示されています。\n\n## 交互作用項 (Interaction Term)\n\n### 交互作用とは\n\nある説明変数の効果が、別の説明変数の値によって変わる場合があります。例えば、「支払総額がチップに与える影響が、喫煙者と非喫煙者で異なる」といった状況です。\n\nこれを分析するために、**交互作用項**を使います。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 交互作用を含むモデル\nmodel_interaction <- lm(tip ~ total_bill * smoker, data = tips)\nsummary(model_interaction)\n#> \n#> Call:\n#> lm(formula = tip ~ total_bill * smoker, data = tips)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -2.6789 -0.5238 -0.1205  0.4749  4.8999 \n#> \n#> Coefficients:\n#>                       Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)           0.360069   0.202058   1.782 0.076012 .  \n#> total_bill            0.137156   0.009678  14.172  < 2e-16 ***\n#> smokerYes             1.204203   0.312263   3.856 0.000148 ***\n#> total_bill:smokerYes -0.067566   0.014189  -4.762 3.32e-06 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 0.9785 on 240 degrees of freedom\n#> Multiple R-squared:  0.506,\tAdjusted R-squared:  0.4998 \n#> F-statistic: 81.95 on 3 and 240 DF,  p-value: < 2.2e-16\n```\n:::\n\n\n結果の見方：\n\n- `total_bill`：非喫煙者における支払総額の効果\n- `smokerYes`：支払総額が0のときの喫煙者と非喫煙者の差（実質的な意味は薄い）\n- `total_bill:smokerYes`：交互作用項。喫煙者における支払総額の効果が、非喫煙者と比べてどれだけ異なるか\n\n### 交互作用の可視化\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntips %>%\n  ggplot(aes(x = total_bill, y = tip, color = smoker)) +\n  geom_point(alpha = 0.5) +\n  geom_smooth(method = \"lm\", se = FALSE) +\n  labs(\n    title = \"喫煙者・非喫煙者別の回帰直線\",\n    x = \"支払総額 (ドル)\",\n    y = \"チップ (ドル)\",\n    color = \"喫煙者\"\n  )\n```\n\n::: {.cell-output-display}\n![](12_regression_2_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## 多重共線性 (Multicollinearity)\n\n### 多重共線性とは\n\n説明変数同士が強く相関している場合、**多重共線性**の問題が生じます。これにより：\n\n- 係数の推定が不安定になる\n- 標準誤差が大きくなる\n- 係数の解釈が困難になる\n\n### VIF（分散膨張因子）による診断\n\n多重共線性の程度は、**VIF (Variance Inflation Factor)** で確認できます。一般的に VIF > 10 の場合、多重共線性が問題となっている可能性があります。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(car)\nvif(model2)\n#> total_bill       size \n#>   1.557586   1.557586\n```\n:::\n\n\nVIF が小さい値であれば、多重共線性の問題は深刻ではありません。\n\n## 相関と因果\n\n### 相関関係と因果関係の違い\n\n「相関関係がある」ことと「因果関係がある」ことは別です。\n例えば、「アイスクリームの売上」と「水難事故の件数」には正の相関がありますが、アイスクリームが事故を引き起こしているわけではありません。\n「気温」という第3の変数（**交絡因子**）が両方に影響しているからです。\n\n### 交絡因子 (Confounding Variable)\n\n交絡因子とは、原因と結果の両方に影響を与える第3の変数のことです。\n\n```\n        気温（交絡因子）\n       /    \\\n      ↓      ↓\nアイス売上 → 水難事故（見せかけの相関）\n```\n\nこの場合、アイスクリームの売上と水難事故の間に直接の因果関係はありませんが、両方とも気温の影響を受けるため、データ上では相関が観察されます。\n\n### 交絡因子をコントロールする\n\n重回帰分析で交絡因子を説明変数として加えることで、その影響を取り除くことができます。\n\n例えば、「教育年数が賃金に与える影響」を分析する場合：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# シミュレーションデータの作成\nset.seed(123)\nn <- 200\n\n# 能力（交絡因子）\nability <- rnorm(n, mean = 100, sd = 15)\n\n# 教育年数（能力の影響を受ける）\neducation <- 12 + 0.05 * ability + rnorm(n, sd = 2)\n\n# 賃金（教育と能力の両方の影響を受ける）\nwage <- 20 + 2 * education + 0.3 * ability + rnorm(n, sd = 5)\n\nsim_data <- tibble(wage, education, ability)\n```\n:::\n\n\n能力をコントロールしない場合としない場合を比較：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 能力をコントロールしない単回帰\nmodel_biased <- lm(wage ~ education, data = sim_data)\n\n# 能力をコントロールした重回帰\nmodel_unbiased <- lm(wage ~ education + ability, data = sim_data)\n\ncat(\"【能力をコントロールしない場合】\\n\")\n#> 【能力をコントロールしない場合】\ncat(\"教育年数の係数:\", coef(model_biased)[\"education\"], \"\\n\\n\")\n#> 教育年数の係数: 2.494524\n\ncat(\"【能力をコントロールした場合】\\n\")\n#> 【能力をコントロールした場合】\ncat(\"教育年数の係数:\", coef(model_unbiased)[\"education\"], \"\\n\")\n#> 教育年数の係数: 1.873354\n```\n:::\n\n\n真の効果は2ですが、能力をコントロールしないと過大評価されることがわかります。\n\n### 因果推論の手法\n\n経済学の実証分析では、交絡因子の影響を取り除き、真の因果効果を明らかにするために様々な手法が使われます：\n\n1. **重回帰分析**：観測可能な交絡因子をコントロール\n2. **操作変数法 (IV)**：交絡因子が観測できない場合に使用\n3. **差の差法 (DID)**：政策介入の効果を推定\n4. **回帰不連続デザイン (RDD)**：閾値を利用した因果推論\n5. **傾向スコアマッチング**：処置群と対照群を比較可能にする\n\nこれらの手法は、計量経済学の上級コースで詳しく学ぶことになります。\n\n## モデルの比較と選択\n\n### 調整済み決定係数\n\n複数のモデルを比較する際、単純な $R^2$ は説明変数を増やすほど大きくなるため、**調整済み決定係数** ($\\bar{R}^2$) を使います。\n\n$$ \\bar{R}^2 = 1 - \\frac{(1 - R^2)(n - 1)}{n - k - 1} $$\n\nここで $n$ は標本サイズ、$k$ は説明変数の数です。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 異なるモデルの調整済みR²を比較\nmodels <- list(\n  \"model1: tip ~ total_bill\" = model_simple,\n  \"model2: tip ~ total_bill + size\" = model2,\n  \"model3: tip ~ total_bill + size + smoker\" = model3,\n  \"model4: tip ~ total_bill + size + smoker + day + time\" = model4\n)\n\nsapply(models, function(m) summary(m)$adj.r.squared)\n#>                              model1: tip ~ total_bill \n#>                                             0.4543712 \n#>                       model2: tip ~ total_bill + size \n#>                                             0.4634533 \n#>              model3: tip ~ total_bill + size + smoker \n#>                                             0.4620370 \n#> model4: tip ~ total_bill + size + smoker + day + time \n#>                                             0.4542383\n```\n:::\n\n\n### AIC と BIC\n\n**AIC (赤池情報量規準)** と **BIC (ベイズ情報量規準)** は、モデルの適合度と複雑さのバランスを評価する指標です。値が小さいほど良いモデルとされます。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# AIC と BIC の比較\ntibble(\n  model = names(models),\n  AIC = sapply(models, AIC),\n  BIC = sapply(models, BIC)\n)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"model\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"AIC\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"BIC\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"model1: tip ~ total_bill\",\"2\":\"707.0762\",\"3\":\"717.5677\"},{\"1\":\"model2: tip ~ total_bill + size\",\"2\":\"703.9702\",\"3\":\"717.9589\"},{\"1\":\"model3: tip ~ total_bill + size + smoker\",\"2\":\"705.5989\",\"3\":\"723.0847\"},{\"1\":\"model4: tip ~ total_bill + size + smoker + day + time\",\"2\":\"713.0098\",\"3\":\"744.4843\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## 講義のまとめ\n\nこの半期の講義では、以下のことを学びました。\n\n1.  RとRStudioの基本操作\n2.  データの可視化と要約\n3.  確率と分布の基礎\n4.  統計的推測（推定と検定）\n5.  回帰分析による関係性の分析\n\nこれらはデータ分析の入り口に過ぎませんが、経済学の学習や卒業論文、そして社会に出てからのデータ活用において強力な武器となるはずです。\n\n## 最終課題\n\n自分の興味のあるデータセットを見つけて（Rに組み込まれているものでも、Web上のオープンデータでも可）、以下の分析を行ってください。\n\n1.  データの概要を説明する。\n2.  ヒストグラムや散布図で可視化する。\n3.  関心のある2変数について回帰分析を行い、結果を解釈する。\n\n### 参考：利用可能なデータセット\n\nRには多くのデータセットが組み込まれています：\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 利用可能なデータセットの一覧\ndata()\n\n# 例：mtcars（自動車データ）\nhead(mtcars)\n\n# 例：iris（アヤメのデータ）\nhead(iris)\n```\n:::\n\n\nWeb上のオープンデータの例：\n\n- **e-Stat**（日本の政府統計）: https://www.e-stat.go.jp/\n- **World Bank Open Data**: https://data.worldbank.org/\n- **Kaggle Datasets**: https://www.kaggle.com/datasets\n\n## 練習問題\n\n1. `tips` データを使って、チップ率（`tip / total_bill`）を被説明変数とした重回帰分析を行い、どの要因がチップ率に影響を与えるか調べてください。\n\n2. `mtcars` データを使って、燃費（`mpg`）を被説明変数とした重回帰分析を行い、結果を解釈してください。\n\n3. 交互作用項を含むモデルを作成し、通常のモデルと比較してください。\n",
    "supporting": [
      "12_regression_2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}