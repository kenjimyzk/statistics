{
  "hash": "11774ee6e5d17d62fc8e4dbaf2f8eb94",
  "result": {
    "engine": "knitr",
    "markdown": "# 第11回 相関と単回帰分析 {.unnumbered}\n\n![相関と単回帰分析](figure/11_regression_1/infographic.png)\n\n## 未来を予測する魔法\n\n「もっと勉強したら、成績はどれくらい上がる？」\n「気温が1度上がったら、ビールは何本多く売れる？」\n\nもし、あるデータ ($X$) を知ることで、未知のデータ ($Y$) を**予測**できるとしたら？\nそれはビジネスでも科学でも、最強の武器になる。\n\n今回は、2つのデータの関係性を読み解き、未来を予測するための数理モデル **単回帰分析** を習得しよう。\n\n## 1. 2人のダンス：相関 (Correlation)\n\n予測の第一歩は、「2つのデータに関係があるか？」を知ること。\nこれを**相関**と呼ぶ。\n\nイメージしてほしい。2人のダンサーが踊っている。\n片方が右に動いたとき、もう片方も必ず右に動くなら、2人の息はピッタリだ（強い正の相関）。\nバラバラに動いているなら、関係はない（無相関）。\n\nこの「息の合い具合」を数値化したのが **相関係数 $r$** 。\n\n-   **$r = 1$**: 完全なシンクロ（正）。\n-   **$r = -1$**: 正反対の動き（負）。\n-   **$r = 0$**: 全くの無関係。\n\n### 実践: 支払額とチップの関係\n\n「支払額 ($X$) が多い客ほど、チップ ($Y$) も多く払うのか？」を確認してみよう。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nurl <- \"https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv\"\ntips <- read_csv(url)\n\n# 相関係数の算出\ncor(tips$total_bill, tips$tip)\n#> [1] 0.6757341\n\n# 検定: その相関は偶然ではないか？\ncor.test(tips$total_bill, tips$tip)\n#> \n#> \tPearson's product-moment correlation\n#> \n#> data:  tips$total_bill and tips$tip\n#> t = 14.26, df = 242, p-value < 2.2e-16\n#> alternative hypothesis: true correlation is not equal to 0\n#> 95 percent confidence interval:\n#>  0.6011647 0.7386372\n#> sample estimates:\n#>       cor \n#> 0.6757341\n```\n:::\n\n\n結果は $r \\approx 0.68$。\n「かなり息が合っている（強い正の相関）」と言える。支払額が増えれば、チップも増える傾向がはっきりとある。\n\n## 2. 予測マシンを作る：単回帰分析\n\n相関があることが分かったら、次は具体的に予測をする。\n「支払いが10ドル増えたら、チップは**いくら**増えるの？」\n\nこの問いに答えるために、データの真ん中を貫く「運命の赤い糸（回帰直線）」を引く。\nこの直線の式が、私たちの**予測マシン**になる。\n\n$$ \\text{予測値} = \\text{切片} + \\text{傾き} \\times \\text{支払額} $$\n\n### 交換レートとしての「傾き」\n\nここで最も重要なのが **傾き ($\\beta_1$)** 。\nこれは、$X$ と $Y$ の**交換レート**のようなもの。\n「支払額を1ドル投入すると、チップが何ドル返ってくるか？」を表す。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 予測モデルの作成\nmodel <- lm(tip ~ total_bill, data = tips)\nsummary(model)\n#> \n#> Call:\n#> lm(formula = tip ~ total_bill, data = tips)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -3.1982 -0.5652 -0.0974  0.4863  3.7434 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 0.920270   0.159735   5.761 2.53e-08 ***\n#> total_bill  0.105025   0.007365  14.260  < 2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 1.022 on 242 degrees of freedom\n#> Multiple R-squared:  0.4566,\tAdjusted R-squared:  0.4544 \n#> F-statistic: 203.4 on 1 and 242 DF,  p-value: < 2.2e-16\n```\n:::\n\n\n**解析結果**:\n-   **傾き (Estimate of total_bill)**: `0.105`\n\nこれは、**「支払額が1ドル増えるごとに、チップは約10.5セント増える」** という法則を表している。\nこれさえ分かれば、まだ見ぬ客のチップ額も予測できる。\n\n### 直線の可視化\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tips, aes(x = total_bill, y = tip)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point() +\n  geom_smooth(method = \"lm\", color = \"red\") +\n  labs(title = \"予測マシン（回帰直線）の可視化\")\n```\n\n::: {.cell-output-display}\n![](11_regression_1_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n赤い線が、推定された予測モデルだ。\n\n## 3. モデルの品質チェック：残差診断\n\nモデルを作って終わりではない。\n「この予測マシンは本当に優秀か？」をチェックする必要がある。\n\n注目するのは、予測と実測のズレ、すなわち **残差 (Residuals)** 。\n完璧なモデルなら、残差は単なる「ランダムなノイズ」になる。もし残差に何らかのパターン（癖）が残っていたら、モデルはまだ何か重要な情報を見落としていることになる。\n\n### 決定係数 ($R^2$): 説明力\n\nまず、このモデルがデータのバラつきの何％を説明できたかを確認する。\n\n-   **Multiple R-squared**: `0.4566`\n    -   「チップの変動の約46%は、支払額の違いで説明できる」\n    -   残りの54%は、支払額以外の要因（客の気前の良さや接客態度など）。\n\n### 残差の健康診断\n\nモデル変な癖がないか、レントゲン（残差プロット）を撮って確認する。\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 予測値と残差の準備\ntips_aug <- tips %>%\n  mutate(pred = predict(model), resid = residuals(model))\n\n# 1. 残差プロット（クセがないか？）\np1 <- ggplot(tips_aug, aes(x = pred, y = resid)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  geom_point() +\n  geom_hline(yintercept = 0, color = \"red\", linetype = \"dashed\") +\n  labs(title = \"残差の散らばり\")\n\n# 2. Q-Qプロット（正規分布しているか？）\np2 <- ggplot(tips_aug, aes(sample = resid)) +\n  theme_gray(base_family = \"HiraKakuProN-W3\") + # [対象注意] Mac用設定\n  stat_qq() +\n  stat_qq_line(color = \"red\") +\n  labs(title = \"残差の正規性\")\n\n# 並べて表示\np1\n```\n\n::: {.cell-output-display}\n![](11_regression_1_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\np2\n```\n\n::: {.cell-output-display}\n![](11_regression_1_files/figure-html/unnamed-chunk-4-2.png){width=672}\n:::\n:::\n\n\n*   **残差プロット**: 0の周りにバランスよく散らばっていれば合格。\n*   **Q-Qプロット**: 赤い線の上に並んでいれば合格。\n\n## 課題\n\n1.  **単回帰分析の実践**:\n    `tips` データを用いて、`size`（客数）を説明変数、$Y=$ `total_bill`（支払総額）を被説明変数とする単回帰分析を行ってください。\n    得られた傾き $\\hat{\\beta}_1$ の値を解釈し、その統計的有意性について述べてください。\n\n## 練習問題\n\n### 練習1: 相関の罠\n架空のデータにおいて、「アイスクリームの売上」と「水難事故の件数」に強い正の相関が見られました。\nこれは「アイスクリームを食べることが水難事故の原因である」ことを意味しますか？第三の要因（交絡因子）を挙げて説明してください。\n\n### 練習2: 決定係数の解釈\nある回帰モデルの決定係数が $R^2 = 0.05$ でしたが、傾きの検定は $p < 0.001$ で有意でした。\nこの結果はどう解釈すべきですか？「モデルは無意味」ですか、それとも「関係はあるが予測精度は低い」ですか？\n\n### 練習3: 残差のパターン\n残差プロットにおいて、残差がU字型のパターンを描いていました。これはモデルの何の仮定に違反している可能性が高いですか？（ヒント：線形性）\n\n## まとめ\n\n| 概念 | アナロジー | 意味 |\n|---|---|---|\n| **相関** | ダンスのシンクロ率 | 2つの変数の動きの連動性。 |\n| **回帰直線** | 予測マシン | $X$ から $Y$ を弾き出す数式。 |\n| **傾き ($\\beta_1$)** | 交換レート | $X$ が1増えると $Y$ がどれだけ増えるか。 |\n| **残差** | 削りカス | モデルが説明しきれなかったノイズ。 |\n| **決定係数 ($R^2$)** | テストの点数 | モデルがどれくらい優秀かのスコア (0-1)。 |\n",
    "supporting": [
      "11_regression_1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}