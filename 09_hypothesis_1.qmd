# 第9回 仮説検定 (1) {.unnumbered}

![仮説検定 (1)](figure/09_hypothesis_1/infographic.png)

## 今回の目標

-   仮説検定の論理（帰無仮説、対立仮説、p値）を理解する。
-   Rを使って1標本のt検定を行う。
-   検定の結果を正しく解釈する。

## 仮説検定とは

仮説検定は、データに基づいて仮説の真偽を判断する統計的手法です。

例えば「新しい薬には効果がある」という主張を検証したいとき：
1. まず「効果がない」という仮説を立てる
2. データを集める
3. 「効果がない」という仮説のもとで、このデータが得られる確率を計算
4. その確率が十分に小さければ、「効果がない」は間違いと判断

## 仮説検定の考え方

「コインが歪んでいないか？」を確かめたいとします。
「歪んでいない（表が出る確率は0.5）」と仮定したときに、実際に起きたこと（例：10回中9回表）が「めったに起きないこと」かどうかを確率で評価します。

-   **帰無仮説 ($H_0$)**: 否定したい仮説（例：差はない、効果はない）。
-   **対立仮説 ($H_1$)**: 主張したい仮説（例：差がある、効果がある）。
-   **p値 (p-value)**: 帰無仮説が正しいとしたときに、今のデータ（またはそれ以上に極端なデータ）が得られる確率。
-   **有意水準 ($\alpha$)**: 帰無仮説を棄却する基準。通常 0.05 (5%) を使います。

**判定ルール**:
-   p値 < 有意水準 $\Rightarrow$ 帰無仮説を棄却する（統計的に有意である）。
-   p値 $\ge$ 有意水準 $\Rightarrow$ 帰無仮説を棄却できない（差があるとは言えない）。

### 検定の手順

1. 帰無仮説と対立仮説を設定
2. 有意水準を決める（通常5%）
3. 検定統計量を計算
4. p値を求める
5. 結論を出す

### 棄却域のイメージ

t分布において、どの範囲に入ったら「極端」とみなされるか（棄却域）を可視化します。

```{r}
library(tidyverse)
theme_set(theme_gray(base_family = "HiraKakuProN-W3"))

# t分布 (自由度9) {.unnumbered}
x <- seq(-4, 4, length.out = 100)
y <- dt(x, df = 9)
df_t <- data.frame(x, y)

# 棄却域 (両側5%) {.unnumbered}
critical_val <- qt(0.975, df = 9)

ggplot(df_t, aes(x = x, y = y)) +
  geom_line() +
  geom_area(data = filter(df_t, x > critical_val), fill = "red", alpha = 0.5) +
  geom_area(data = filter(df_t, x < -critical_val), fill = "red", alpha = 0.5) +
  geom_vline(xintercept = c(critical_val, -critical_val), linetype = "dashed") +
  labs(title = "t分布と棄却域 (両側5%)", x = "t値", y = "確率密度")
```

## 1標本のt検定

あるデータの平均値が、特定の値 $\mu_0$ と異なるかどうかを検定します。

例：あるクラスのテストの平均点が、全国平均の50点と異なるか？

```{r}
# サンプルデータ作成 {.unnumbered}
scores <- c(55, 60, 45, 70, 58, 62, 48, 52, 65, 50)

# t検定 (mu = 50 と比較) {.unnumbered}
t.test(scores, mu = 50)
```

結果の見方:

1.  **p値 (p-value)**: `0.02939` となりました。
    -   これは、「もし本当にクラスの平均点が50点だとしたら、今回のような（あるいはもっと極端な）データが得られる確率は約2.9%しかない」という意味です。
    -   この確率は、一般的な基準である有意水準 5% (0.05) よりも小さいです。
2.  **結論**: 帰無仮説（平均点は50点である）を棄却します。
    -   つまり、「偶然で片付けるには確率が低すぎる」と判断し、「このクラスの平均点は50点とは統計的に有意に異なる」と結論づけます。
    -   95%信頼区間 (`50.8` 〜 `62.2`) を見ても、50点が含まれていないことがわかります。

## 両側検定と片側検定

### 両側検定（デフォルト）

「等しくない」ことを検定します。

$H_0: \mu = \mu_0$ vs $H_1: \mu \neq \mu_0$

### 片側検定

「大きい」または「小さい」ことを検定します。

```{r}
# 「50点より大きい」ことを検定（片側検定）
t.test(scores, mu = 50, alternative = "greater")
```

## 検定の誤り

仮説検定では2種類の誤りがありえます。

| | 帰無仮説が真 | 帰無仮説が偽 |
|---|------------|------------|
| 帰無仮説を棄却 | **第1種の誤り（α）** | 正しい判断 |
| 帰無仮説を棄却しない | 正しい判断 | **第2種の誤り（β）** |

- **第1種の誤り（偽陽性）**: 実際には差がないのに「差がある」と判断してしまう
- **第2種の誤り（偽陰性）**: 実際には差があるのに「差がない」と判断してしまう
- **検出力 (Power)**: $1 - \beta$。真の差を検出できる確率

### 有意水準と検出力のトレードオフ

有意水準を厳しくすると（5%→1%）：
- 第1種の誤りは減る
- 第2種の誤りは増える（検出力が下がる）

## 課題

1.  `tips` データの `total_bill` の平均値が 20ドル と異なるかどうかを検定してください。
    帰無仮説、対立仮説、p値、そして結論（棄却するかどうか）を答えてください。

## 練習問題

### 練習1: 1標本t検定
ある会社の従業員10人の残業時間（月間）が以下のデータだとします：

```{r}
#| eval: false
overtime <- c(45, 50, 38, 55, 42, 48, 52, 40, 35, 50)
```

法定の残業上限である月45時間と比較して、この会社の残業時間は有意に多いですか？

### 練習2: 片側検定と両側検定
1. 上の練習問題を両側検定で行ってください
2. 「45時間より多い」かどうかを片側検定で行ってください
3. 結果の違いを確認してください

### 練習3: p値の解釈
以下の場合、帰無仮説を棄却しますか？理由も答えてください。
1. p値 = 0.03, 有意水準 = 0.05
2. p値 = 0.08, 有意水準 = 0.05
3. p値 = 0.001, 有意水準 = 0.01

## 仮説検定の注意点

1. **統計的有意 ≠ 実質的に重要**: p値が小さくても、効果の大きさが小さい場合がある
2. **「棄却しない」≠「帰無仮説が正しい」**: 差がないと証明したわけではない
3. **p値は確率ではない**: 「帰無仮説が正しい確率」ではない
4. **多重検定の問題**: 何度も検定を繰り返すと、偶然有意になりやすい
