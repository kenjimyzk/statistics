# 第3回 記述統計 (1) 数値要約 {.unnumbered}

![記述統計 (1) 数値要約](figure/03_desc_stat_1/infographic.png)

## 情報を「縮約」する

手元に1万人の顧客データがあるとします。上司に「客層はどうだい？」と聞かれたら、どう答えますか。
1万人全員の年齢を読み上げるわけにはいきません。「だいたい30代です」と答えるはずです。

記述統計（Descriptive Statistics）の本質は、ここにあります。
膨大な生のデータを、たった1つの数字（要約統計量）にまで圧縮する。多くの情報は捨てられますが、代わりに人間が理解できる「特徴」が浮かび上がります。

本節では、この「情報の圧縮技術」を学びます。キーとなるのは次の2点です。

1.  **どこに集まっているか（中心的傾向）**
2.  **どれくらい散らばっているか（散布度）**

## 準備

前回に引き続き、`tidyverse` パッケージと、`tips` データセット（Bryant & Smith, 1995）を使います。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)
```

## 中心を探す：代表値

まずはデータの「顔」となる中心点を探します。ただ、「中心」の定義は一つではありません。

### 1. 全員の声を聞く：平均値 (Mean)

すべてのデータを足し合わせ、人数で割る。一番なじみ深い「中心」でしょう。

$$\bar{x} = \frac{1}{n}\sum_{i=1}^{n} x_i$$

```{r}
mean(tips$total_bill)
```

この指標には「全員の値を公平に扱う」という民主的な良さがあります。反面、**極端な声（外れ値）に弱い**のが欠点です。たった一人の超富裕層がいるだけで、全員の平均所得は跳ね上がってしまいます。

### 2. 真ん中の人を見る：中央値 (Median)

データを一列に並べたとき、ちょうど真ん中にいる人の値です。

```{r}
median(tips$total_bill)
```

こちらは「順位」しか見ないので、極端な値の影響をほとんど受けません（頑健性）。

### 3. 多派を見る：最頻値 (Mode)

最も頻繁に現れる値です。数値データよりも、アンケートの回答（賛成/反対）などのカテゴリデータで威力を発揮します。

```{r}
# Rには標準関数がないため、集計して確認
tips %>% 
  count(day) %>% 
  arrange(desc(n))
```

### 意思決定：平均か、中央値か

どっちを使うべきか。迷ったら「世界の形（分布）」を見ます。

| 分布の形状 | 選び方の指針 |
|------|------------------|
| **左右対称**（テストの点数など） | どちらもほぼ同じ値になります。数学的に扱いやすい**平均値**を選びます。 |
| **歪んでいる**（年収、貯蓄額など） | 右に裾が長い場合、平均値は高すぎ​​る値になります。実感を反映する**中央値**を選びます。 |

## 広がりを測る：散布度

データの特徴は「中心」だけでは語れません。「平均年収500万」と言っても、全員が500万の国と、0円と1000万がいる国では全く別物です。
この「散らばり具合」を数値にします。

### 最大と最小：範囲 (Range)

一番上と一番下の差です。単純ですが、全体像を掴むにはこれで十分なことも多いです。

```{r}
range(tips$total_bill)  # 最小値と最大値
max(tips$total_bill) - min(tips$total_bill)  # その差（範囲）
```

### 中心からの距離：分散 (Variance)

「平均からどれくらい離れているか」を全データについて計算し、平均したもの。
直感的には「差の絶対値」を平均したくなりますよね。でも、統計学では数学的な都合から「差を**二乗**」して扱います。

**Rの注意点**: Rの `var()` 関数は、手元のデータを標本とみなした**不偏分散**（分母が $n-1$）を計算します。

$$s^2 = \frac{1}{n-1}\sum_{i=1}^{n} (x_i - \bar{x})^2$$

```{r}
var(tips$total_bill)
```

### 単位を戻す：標準偏差 (Standard Deviation)

分散は計算過程で「二乗」しているため、単位が「ドルの二乗」のようになり、直感的に分かりにくい。
そこで、平方根をとって元の単位に戻したのが**標準偏差**です。

$$s = \sqrt{s^2}$$

```{r}
sd(tips$total_bill)
```

「平均値 $\pm$ 標準偏差」の範囲に、多くのデータ（正規分布なら約68%）が含まれると考えるとイメージしやすいでしょう。

### 単位を消す：変動係数 (CV)

「象の体重のばらつき」と「アリの体重のばらつき」を比べたいとき、標準偏差（kgやg）そのままでは比較できません。
平均値に対する比率（%）に直すことで、スケールの異なるデータでも比べられます。

$$CV = \frac{s}{\bar{x}} \times 100\%$$

```{r}
# チップの額と、支払総額。どちらが「ばらついて」いるか？
cv_tip <- sd(tips$tip) / mean(tips$tip) * 100
cv_bill <- sd(tips$total_bill) / mean(tips$total_bill) * 100

cat("チップの変動係数:", cv_tip, "%\n")
cat("支払総額の変動係数:", cv_bill, "%\n")
```

## 全体像をスキャンする：四分位数

データを小さい順に並べて4等分した地点（25%, 50%, 75%）を**四分位数**と呼びます。
`summary()` 関数を使えば、これらの主要な統計量を一括で確認できます。

```{r}
summary(tips$total_bill)
```

-   **Median**（50%地点）と **Mean**（平均）のズレを見ることで、データの歪みを推測できます。
-   **1st Qu**（25%）から **3rd Qu**（75%）の間には、データの中央半数が含まれます。

### 安定した広がり：四分位範囲 (IQR)

データの中央50%が収まる幅（第3四分位数 $-$ 第1四分位数）を**四分位範囲**と呼びます。
標準偏差と違い、極端な値の影響を受けないため、外れ値を含むデータでのばらつき指標として優秀です。

```{r}
IQR(tips$total_bill)
```

## ノイズか、シグナルか：外れ値の検出

統計分析において、極端に離れた値（外れ値）は厄介な存在です。入力ミス（ノイズ）なのか、特異な事象（シグナル）なのかを見極める必要があります。
一般的に、箱ひげ図のTukeyの基準を用いて「外れ値候補」を機械的に検出します。

-   **下限**: 第1四分位数 - 1.5 × IQR
-   **上限**: 第3四分位数 + 1.5 × IQR

```{r}
Q1 <- quantile(tips$total_bill, 0.25)
Q3 <- quantile(tips$total_bill, 0.75)
IQR_val <- IQR(tips$total_bill)

# 境界線の計算
lower_bound <- Q1 - 1.5 * IQR_val
upper_bound <- Q3 + 1.5 * IQR_val

cat("外れ値の下限:", lower_bound, "\n")
cat("外れ値の上限:", upper_bound, "\n")

# 境界を超えたデータを抽出してみる
tips %>% 
  filter(total_bill < lower_bound | total_bill > upper_bound) %>% 
  select(total_bill, tip, day, time)
```

## 分布の歪みを可視化する

平均値と中央値がずれているとき、実際にグラフを描くとその理由がわかります。
ヒストグラムに両者の位置を重ねてみましょう。

```{r}
# 統計量の計算 {.unnumbered}
mean_val <- mean(tips$total_bill)
med_val <- median(tips$total_bill)

# プロット {.unnumbered}
ggplot(tips, aes(x = total_bill)) +
  theme_gray(base_family = "HiraKakuProN-W3") + # [対象注意] Mac用設定
  geom_histogram(bins = 30, fill = "lightgray", color = "white") +
  geom_vline(xintercept = mean_val, color = "red", linetype = "dashed", size = 1) +
  geom_vline(xintercept = med_val, color = "blue", linetype = "solid", size = 1) +
  annotate("text", x = mean_val + 5, y = 30, label = "Mean (Red)", color = "red") +
  annotate("text", x = med_val - 5, y = 30, label = "Median (Blue)", color = "blue") +
  labs(title = "平均値（赤破線）と中央値（青実線）")
```

## グループごとに要約する

全体の平均だけでは見えない違いもあります。性別や喫煙の有無など、属性ごとに分けて要約することで、より深い洞察が得られます。

```{r}
tips %>% 
  group_by(sex) %>% 
  summarize(
    avg_bill = mean(total_bill),
    sd_bill = sd(total_bill),
    count = n() # サンプルサイズも必ず確認する
  )
```

## 課題

自分の手でデータを縮約してみましょう。

1.  `tips` データを使用し、時間帯 (`time`) ごとのチップ (`tip`) の平均値を算出してください。
2.  `summary()` 関数を使用し、チップ (`tip`) の分布の要約統計量を確認してください。

## 練習問題

### 練習1: 基本的な記述統計の算出

`tips` データの `size`（グループの人数）について、以下の4つの統計量を算出してください。

1. 平均値
2. 中央値
3. 標準偏差
4. 範囲（最小値と最大値）

### 練習2: グループ別の比較検証
喫煙者 (`smoker == "Yes"`) と非喫煙者 (`smoker == "No"`) の2群において、支払総額 (`total_bill`) の平均値と標準偏差を比較してください。

### 練習3: 外れ値の影響を体感する
1. `tips` データに極端な外れ値（例: `total_bill = 100`）を持つ行を追加した新しいデータを作成してください。
2. 元のデータと新しいデータで、平均値と中央値がそれぞれどれくらい変化したかを確認してください。どちらが「頑健」でしたか？

<br>
※本節で用いた記述統計の指標一覧は、練習問題の振り返りとして自身のノートにまとめておくことを推奨します。
