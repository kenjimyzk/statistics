# 第2回 データの構造と扱い {.unnumbered}

![データの構造](figure/02_data/infographic.png)

## 今回の目標

-   Rでのデータの持ち方（データフレーム）を理解する。
-   外部データ（CSVファイルなど）を読み込む方法を学ぶ。
-   **Tidyverse** パッケージを使った基本的なデータ操作を学ぶ。

## パッケージの準備

Rには便利な機能を追加する **パッケージ** という仕組みがあります。
この講義では、データ分析に必須のパッケージ群 **Tidyverse** を使います。

### Tidyverseとは

Tidyverseは、データサイエンスのために設計されたパッケージの集合体です。主に以下のパッケージが含まれています：

| パッケージ | 主な用途 |
|-----------|---------|
| `ggplot2` | データの可視化（グラフ作成） |
| `dplyr` | データの操作・加工 |
| `tidyr` | データの整形 |
| `readr` | データの読み込み |
| `stringr` | 文字列の操作 |
| `forcats` | カテゴリ変数（因子）の操作 |

初回のみインストールが必要です（前回の課題で実施済みなら不要）。

```{r}
# install.packages("tidyverse") {.unnumbered}
```

使うときは毎回 `library()` 関数で読み込みます。

```{r}
library(tidyverse)
```

## データフレーム

統計分析では、Excelのような表形式のデータを扱います。Rではこれを **データフレーム** と呼びます。
Rには練習用のデータセットがいくつか入っています。`iris`（アヤメのデータ）を見てみましょう。

```{r}
head(iris) # 最初の6行を表示
```

### データフレームの構造を確認する

```{r}
# データの次元（行数 × 列数）
dim(iris)

# 列名の確認
names(iris)

# データの構造を確認
str(iris)
```

### データ型について

Rには主に以下のデータ型があります：

| データ型 | 説明 | 例 |
|---------|------|-----|
| numeric | 数値 | 1.5, 100, -3.14 |
| integer | 整数 | 1L, 2L, 100L |
| character | 文字列 | "東京", "hello" |
| logical | 論理値 | TRUE, FALSE |
| factor | カテゴリ | 男性/女性, 大/中/小 |

## データの読み込み

自分のデータを分析するには、CSVファイルなどを読み込む必要があります。
`read_csv()` 関数を使います。

```{r}
# data.csv というファイルがある場合の例 {.unnumbered}
# df <- read_csv("data.csv") {.unnumbered}
```

### よく使うデータ読み込み関数

| 関数 | ファイル形式 | パッケージ |
|------|-------------|-----------|
| `read_csv()` | CSV（カンマ区切り） | readr (tidyverse) |
| `read_tsv()` | TSV（タブ区切り） | readr (tidyverse) |
| `read_excel()` | Excel (.xlsx) | readxl |
| `read.csv()` | CSV | base R |

今回は、Web上のCSVデータを読み込んでみましょう。

```{r}
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)
```

データの概要を確認します。

```{r}
glimpse(tips)
```

### tipsデータの説明

このデータはレストランでのチップに関するデータです。

| 変数名 | 説明 |
|--------|------|
| total_bill | 支払総額（ドル） |
| tip | チップの額（ドル） |
| sex | 支払者の性別 |
| smoker | 喫煙者かどうか |
| day | 曜日 |
| time | 時間帯（ランチ/ディナー） |
| size | グループの人数 |

## データの操作 (dplyr)

Tidyverseに含まれる `dplyr` パッケージを使うと、データの加工が直感的に行えます。

### 1. 列を選ぶ: `select()`

特定の列だけを取り出します。

```{r}
tips %>% 
  select(total_bill, tip) %>% 
  head()
```

`%>%` は **パイプ演算子** といい、「左の結果を右の関数に渡す」という意味です。
「tipsデータ **を** selectする」と読みます。

### 2. 行を選ぶ: `filter()`

条件に合う行だけを取り出します。
例えば、`time` が "Dinner" のデータだけ抽出します。

```{r}
tips %>% 
  filter(time == "Dinner") %>% 
  head()
```

### 3. 新しい列を作る: `mutate()`

計算結果などを新しい列として追加します。
チップの割合（チップ / 総額）を計算してみましょう。

```{r}
tips %>% 
  mutate(tip_rate = tip / total_bill) %>% 
  select(total_bill, tip, tip_rate) %>% 
  head()
```

### 5. データの並び替え: `arrange()`

データを特定の列の値で並び替えます。

```{r}
# 支払総額の小さい順に並べる
tips %>% 
  arrange(total_bill) %>% 
  head()

# 降順（大きい順）にする場合は desc() を使う
tips %>% 
  arrange(desc(total_bill)) %>% 
  head()
```

### 6. 要約統計量を計算: `summarize()`

データの要約統計量（平均、合計など）を計算します。

```{r}
tips %>% 
  summarize(
    平均支払額 = mean(total_bill),
    平均チップ = mean(tip),
    データ数 = n()
  )
```

グループごとに集計する場合は、`group_by()` と組み合わせます。

```{r}
# 曜日ごとの平均支払額を計算
tips %>% 
  group_by(day) %>% 
  summarize(
    平均支払額 = mean(total_bill),
    データ数 = n()
  )
```

## パイプ演算子 `%>%` の活用

パイプ演算子を使うと、複数の操作を順番につなげられます。
「データを読み込んで、フィルタして、新しい列を作って、並び替える」といった一連の操作を、読みやすく書けます。

```{r}
# 例: ディナーのデータだけを抽出し、チップ率を計算し、支払額の大きい順に並べる
tips %>% 
  filter(time == "Dinner") %>% 
  mutate(tip_rate = tip / total_bill * 100) %>%  # パーセントで表示
  arrange(desc(total_bill)) %>% 
  select(total_bill, tip, tip_rate, day) %>% 
  head(10)  # 上位10件のみ表示
```

## データ操作のヒント

### ヒント1: 列名の指定方法
列を指定する方法は2つあります。

```{r}
#| eval: false
# 方法1: $ を使う
tips$total_bill

# 方法2: dplyrで直接列名を書く（パイプと相性が良い）
tips %>% select(total_bill)
```

### ヒント2: 複数の条件を組み合わせる
`filter()` では、`&`（かつ）や `|`（または）を使って複数の条件を組み合わせられます。

```{r}
# 支払額が20ドル以上、かつディナーのデータ
tips %>% 
  filter(total_bill >= 20 & time == "Dinner") %>% 
  head()
```

### 4. データの可視化（チラ見せ）

`ggplot2` を使うと、データの分布を簡単に可視化できます。
例えば、男女 (`sex`) の人数を棒グラフにしてみましょう。

```{r}
ggplot(tips, aes(x = sex)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_bar()
```

## 課題

読み込んだ `tips` データを使って、以下の操作を行ってください。

1.  `day` が "Sun"（日曜日）のデータだけを `filter()` で抽出してください。
2.  抽出したデータから、`total_bill` と `size` の列だけを `select()` で選んで表示してください。

## 練習問題

### 練習1: データの確認
1. `tips` データの行数と列数を確認してください
2. `tips` データの最後の6行を表示してください（ヒント: `tail()` 関数）

### 練習2: フィルタリング
1. チップ (`tip`) が3ドル以上のデータだけを抽出してください
2. 女性 (`sex == "Female"`) かつディナー (`time == "Dinner"`) のデータを抽出してください

### 練習3: データ加工の組み合わせ
以下の操作を1つのパイプでつなげて実行してください：
1. 土曜日 (`day == "Sat"`) のデータを抽出
2. チップ率 (`tip / total_bill * 100`) を新しい列として追加
3. チップ率の高い順に並び替え
4. 上位5件を表示

## dplyr関数のまとめ

| 関数 | 用途 | 例 |
|------|------|-----|
| `select()` | 列を選択 | `select(data, col1, col2)` |
| `filter()` | 行を抽出 | `filter(data, x > 10)` |
| `mutate()` | 新しい列を作成 | `mutate(data, new = x + y)` |
| `arrange()` | 並び替え | `arrange(data, x)` |
| `summarize()` | 要約統計量 | `summarize(data, mean(x))` |
| `group_by()` | グループ化 | `group_by(data, category)` |
