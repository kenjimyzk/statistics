# 第10回 仮説検定 (2) {.unnumbered}

![仮説検定 (2)](figure/10_hypothesis_2/infographic.png)

## A vs B：決着をつけよう

「新薬Aは、プラセボBより効くのか？」
「新しい教育プログラムを受けた生徒は、受けていない生徒より成績が良いか？」
「ダイエット前後で、体重は本当に減ったのか？」

私たちの世界は、比較で溢れている。
しかし、単に平均値を比べるだけでは不十分。偶然のバラつきかもしれないからだ。

今回は、2つのグループの間に「意味のある差」があるかどうかを判定する、統計学の定番技 **2標本のt検定** をマスターしよう。

## 1. 2つの島を比べる：対応のないt検定

まずは、全く別々の2つのグループを比較するケース。
例えば、「ランチ島」に住む人々と、「ディナー島」に住む人々。
彼らの支払金額に差はあるのか？

このように、互いに独立したデータを比較する手法を**対応のないt検定 (Unpaired t-test)** と呼ぶ。

### 地形を選ばない万能車：Welchのt検定

2つの島（グループ）は、地形（データのばらつき＝分散）が同じとは限らない。
昔の教科書には「まず地形が同じか調べて（F検定）、それから車を選べ」と書いてあった。

しかし、現代の統計学では**Welchのt検定**という「全地形対応車」を最初から使うのが常識。
これなら、分散が違っていても安全に走行（検定）できる。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)

# 箱ひげ図：2つの島の地形確認
ggplot(tips, aes(x = time, y = total_bill, fill = time)) +
  theme_gray(base_family = "HiraKakuProN-W3") + # [対象注意] Mac用設定
  geom_boxplot() +
  labs(title = "ランチとディナーの支払総額比較")

# Welchのt検定（デフォルトで適用されます）
t.test(total_bill ~ time, data = tips)
```

**判定**:
p値は約 `0.002`。これは「差がないとしたら、こんなデータは0.2%の確率でしか起きない」ことを意味する。
偶然とは考えにくい。つまり、**ランチとディナーには有意な差がある**と結論づける。

## 2. ビフォー・アフター：対応のあるt検定

次は、同じ人が「変身」するケース。
ダイエット前とダイエット後。テスト勉強前と勉強後。

ここでは、グループ全体の平均を見るのではなく、**「一人ひとりの変化（差分）」**に注目する。
これを**対応のあるt検定 (Paired t-test)** と呼ぶ。

### 変化を捕まえる

同じ人のデータを追跡することで、個人の「もともとの性質」をキャンセルし、純粋な「変化」だけを取り出すことができる。

```{r}
# 5人のダイエット記録
before <- c(70, 80, 75, 60, 65)
after  <- c(68, 78, 74, 58, 64)

# paired = TRUE で「対応あり」を指定
t.test(before, after, paired = TRUE)
```

**事実確認**:
もしこれを「対応なし（別人のデータ）」として分析してしまうと、p値は `0.75` になり、「差なし」と判定されてしまう。
対応のある検定を使うことで初めて、微小な変化（-1.6kg）を「有意」として検出できるのだ。

## 3. その差は、どれくらい凄いのか？：効果量

p値が小さいことは、「偶然ではない」ことを保証するだけ。
「すごい差がある」ことの証明ではない。

1万人調査すれば、0.1ミリの身長差でも「有意差あり（p < 0.05）」になる。でも、0.1ミリに意味はあるか？

そこで必要なのが、差の実質的な大きさを表す「スコア」、すなわち**効果量 (Effect Size)** 。
代表的なスコアである **Cohen's d** を使おう。

### シグナルの強さを測る

$$Cohen's \ d = \frac{\text{平均値の差}}{\text{標準偏差（ばらつき）}}$$

これは、「データのばらつき（ノイズ）」に対して、「平均値の差（シグナル）」がどれくらい突き抜けているかを表す。

*   **0.2**: 小さい（ノイズに埋もれがち）
*   **0.5**: 中くらい（肉眼でもなんとなく分かる）
*   **0.8**: 大きい（誰が見ても明らか）

```{r}
# ランチとディナーの差のスコア（Cohen's d）
d_val <- (mean(tips$total_bill[tips$time=="Dinner"]) - mean(tips$total_bill[tips$time=="Lunch"])) /
         sd(tips$total_bill)

d_val
```

スコアは約 `0.41`。中程度の効果だ。
「この差は統計的に有意であり、実質的にも中程度の意味がある」と、胸を張って報告しよう。


## 課題

1.  **喫煙の有無とチップ**:
    `tips` データを使って、喫煙者 (`Smoker`) と非喫煙者 (`Non-Smoker`) で、チップの額 (`tip`) に差があるかを検定してください（Welchのt検定）。
    また、その差の効果量 (Cohen's d) を計算し、統計的有意性と実質的意味について論じてください。

## 練習問題

### 練習1: 検定の選択
以下のシナリオにおいて、最も適切な検定手法（対応ありt検定 / 対応なし(Welch)t検定）を選んでください。

1.  A組30人とB組30人のテストの平均点の比較。
2.  高血圧患者30人の、降圧剤投与前と投与後の血圧の比較。
3.  10組の双子における、兄と弟の身長の比較。

### 練習2: サンプルサイズとp値
効果量 $d=0.5$ （中程度）の差がある2つの母集団から、
(a) $n=10$ ずつ
(b) $n=100$ ずつ
データを抽出し、t検定を行った場合のp値をシミュレーションで比較してください。サンプルサイズがp値に与える影響を確認します。

### 練習3: 等分散性の確認はいらない？
「まずF検定をしてからt検定の種類を選ぶ」という手順が、現在では推奨されない理由を自分の言葉で説明してください。

## まとめ

| 検定手法 | 適用場面 | Rコード | 備考 |
|---|---|---|---|
| **Welchのt検定** | 独立した2群の比較 | `t.test(y ~ x)` | デフォルト。等分散を仮定しない。 |
| **対応のあるt検定** | 同一対象・ペアの比較 | `t.test(y1, y2, paired=TRUE)` | 差分の1標本検定と等価。検出力が高い。 |
| **効果量 (Cohen's d)** | 差の実質的な大きさ | (計算式参照) | サンプルサイズに依存しない指標。 |
