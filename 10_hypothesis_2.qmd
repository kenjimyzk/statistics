# 第10回 仮説検定 (2) {.unnumbered}

![仮説検定 (2)](figure/10_hypothesis_2/infographic.png)

## 今回の目標

-   2つのグループの平均値に差があるかどうかを検定する。
-   対応のあるデータと対応のないデータの違いを理解する。
-   効果量の概念を理解する。

## 2標本のt検定の種類

| 種類 | 状況 | 例 |
|------|------|-----|
| 対応なし | 独立した2群を比較 | 男性vs女性、薬vsプラセボ |
| 対応あり | 同じ対象の前後を比較 | ダイエット前後、学習前後 |

## 2標本のt検定（対応なし）

異なる2つのグループ（例：男性と女性、投薬群とプラセボ群）の平均値を比較します。

`tips` データで、ランチ (`Lunch`) とディナー (`Dinner`) で支払総額 (`total_bill`) に差があるか検定してみましょう。

```{r}
library(tidyverse)
url <- "https://raw.githubusercontent.com/mwaskom/seaborn-data/master/tips.csv"
tips <- read_csv(url)



# 箱ひげ図で確認 {.unnumbered}
ggplot(tips, aes(x = time, y = total_bill, fill = time)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_boxplot() +
  labs(title = "ランチとディナーの支払総額比較")

# 密度図でも確認 {.unnumbered}
ggplot(tips, aes(x = total_bill, fill = time)) +
  theme_gray(base_family = "HiraKakuProN-W3") +
  geom_density(alpha = 0.5) +
  labs(title = "支払総額の分布比較 (密度図)")

# t検定 {.unnumbered}
# total_bill ~ time は「total_bill を time で分ける」という意味 {.unnumbered}
t.test(total_bill ~ time, data = tips)
```

結果の見方:

1.  **p値 (p-value)**: `0.002167` となりました。
    -   これは 0.05 よりはるかに小さい値です。したがって、帰無仮説（ランチとディナーで支払総額に差はない）を棄却します。
    -   結論として、「ランチとディナーの支払総額には統計的に有意な差がある」と言えます。
2.  **平均値の比較**:
    -   `mean in group Dinner`: 約 20.8 ドル
    -   `mean in group Lunch`: 約 17.2 ドル
    -   ディナーの方が平均して約 3.6 ドル高いことがわかります。95%信頼区間 (`1.33` 〜 `5.93`) も0を含んでおらず、差がプラス（ディナーが高い）であることを示しています。

## 対応のあるt検定 (Paired t-test)

同じ対象に対して2回測定した場合（例：ダイエット前後の体重、テストの事前事後）の比較です。
`paired = TRUE` オプションを使います。

```{r}
# サンプルデータ（ダイエット前後の体重） {.unnumbered}
before <- c(70, 80, 75, 60, 65)
after  <- c(68, 78, 74, 58, 64)

t.test(before, after, paired = TRUE)
```

結果の見方:

1.  **p値**: `0.002838` となりました。
    -   0.05 より小さいため、帰無仮説（ダイエット前後で差はない）を棄却します。
    -   「ダイエット前後で体重には有意な変化があった」と言えます。
2.  **平均差 (mean difference)**:
    -   `1.6` となっています。これは `before - after` の平均値です。
    -   つまり、平均して 1.6kg 体重が減少したことを意味します（プラスの値なので、beforeの方が大きい）。

## 等分散の仮定

2標本t検定には、両群の分散が等しいという仮定があります。Rの `t.test()` はデフォルトでWelchのt検定（等分散を仮定しない）を使用します。

```{r}
# Welchのt検定（デフォルト）
t.test(total_bill ~ time, data = tips)

# Studentのt検定（等分散を仮定）
t.test(total_bill ~ time, data = tips, var.equal = TRUE)
```

結果の比較:

1.  **Welchのt検定** (等分散を仮定しない):
    -   t統計量: `3.123`、自由度: `143.29`、p値: `0.002167`
    -   95%信頼区間: `1.33` 〜 `5.93`
    -   自由度が小数になっているのは、Welch-Satterthwaiteの近似を使用しているためです。
2.  **Studentのt検定** (等分散を仮定する):
    -   t統計量: `2.898`、自由度: `242`、p値: `0.004105`
    -   95%信頼区間: `1.16` 〜 `6.10`
    -   自由度は単純に `n1 + n2 - 2` = `176 + 68 - 2 = 242` となります。
3.  **両者の違い**:
    -   Welchのt検定の方がp値が小さく（より有意）、信頼区間も狭くなっています。
    -   これは、2群のサンプルサイズが異なる場合（ディナー176件 vs ランチ68件）、Welchの方がより正確だからです。
    -   **実務上の推奨**: 等分散性が確実でない限り、**Welchのt検定を使用する方が安全** です。

等分散かどうかは、F検定やLevene検定で確認できます。

```{r}
# F検定（等分散の検定）
var.test(total_bill ~ time, data = tips)
```

結果の見方:

1.  **p値**: `0.1109` となりました。
    -   これは 0.05 より大きいため、帰無仮説（2群の分散が等しい）を棄却できません。
    -   つまり、ランチとディナーの支払総額の **分散に有意な差があるとは言えない** という結論になります。
2.  **分散比 (ratio of variances)**:
    -   `1.4046` となっています。これはディナーの分散がランチの分散の約1.4倍であることを示します。
    -   しかし、95%信頼区間 (`0.924` 〜 `2.060`) が1を含んでいるため、この差は統計的に有意ではありません。
3.  **実務的な意味**:
    -   等分散性が棄却されなかったため、Studentのt検定を使用することもできますが、一般的には **Welchのt検定（デフォルト）の方が安全** です。
    -   Welchのt検定は等分散を仮定しないため、分散が異なる場合でも適切に機能します。

## 効果量 (Effect Size)

p値だけでは効果の大きさがわかりません。**効果量**を計算することで、実質的な差の大きさを評価できます。

### Cohen's d

2群の平均値の差を標準偏差で割った指標です。

$$d = \frac{\bar{x}_1 - \bar{x}_2}{s_{pooled}}$$

- $|d| < 0.2$: 小さい効果
- $0.2 \le |d| < 0.8$: 中程度の効果
- $|d| \ge 0.8$: 大きい効果

```{r}
# Cohen's d の計算
dinner <- tips$total_bill[tips$time == "Dinner"]
lunch <- tips$total_bill[tips$time == "Lunch"]

mean_diff <- mean(dinner) - mean(lunch)
pooled_sd <- sqrt(((length(dinner)-1)*var(dinner) + (length(lunch)-1)*var(lunch)) / 
                   (length(dinner) + length(lunch) - 2))

cohens_d <- mean_diff / pooled_sd
cat("Cohen's d:", cohens_d, "\n")
```

結果の解釈:

1.  **効果量の大きさ**: Cohen's d は `0.414` となりました。
    -   これは `0.2 ≤ |d| < 0.8` の範囲に入るため、**中程度の効果** と判断されます。
    -   ランチとディナーの支払総額の差は、実質的にも意味のある大きさであると言えます。
2.  **p値との関係**:
    -   t検定でp値が `0.002167` と統計的に有意でした（**統計的有意性**）。
    -   Cohen's d が `0.414` で中程度の効果を示しています（**実質的意義**）。
    -   つまり、この差は統計的に有意であるだけでなく、実務的にも意味のある大きさだと結論できます。
3.  **解釈のポイント**:
    -   サンプルサイズが大きい場合、小さな差でもp値が有意になることがあります。
    -   効果量を確認することで、その差が実質的に意味があるかどうかを判断できます。
    -   **p値と効果量を併せて報告することが重要** です。

## 課題

1.  `tips` データを使って、喫煙者 (`Smoker`) と非喫煙者 (`Non-Smoker`) で、チップの額 (`tip`) に差があるかどうかを検定してください。
    （注：データ内の値は "Yes" / "No" です）

## 練習問題

### 練習1: 2標本t検定
`tips` データを使って以下の検定を行ってください：
1. 男性と女性で支払総額 (`total_bill`) に差があるか
2. 土曜日と日曜日でチップ (`tip`) に差があるか

### 練習2: 対応のあるt検定
以下は10人の学生のテスト前後の点数です：

```{r}
#| eval: false
pre_test <- c(65, 70, 75, 60, 80, 55, 70, 65, 75, 70)
post_test <- c(70, 75, 80, 65, 85, 60, 78, 70, 80, 75)
```

1. 対応のあるt検定で、テストの点数が向上したか検定してください
2. 効果量（Cohen's d）を計算してください

### 練習3: 検定の選択
以下の状況では、どの検定を使うべきですか？
1. 新薬を投与した群とプラセボ群の血圧を比較
2. 同じ患者の治療前と治療後の血圧を比較
3. 3つの異なる運動プログラムの効果を比較

## 検定のまとめ

| 検定 | 用途 | R関数 |
|------|------|-------|
| 1標本t検定 | 1群の平均と特定の値の比較 | `t.test(x, mu = value)` |
| 2標本t検定（対応なし） | 独立した2群の平均の比較 | `t.test(y ~ group, data)` |
| 2標本t検定（対応あり） | 対応のある2群の平均の比較 | `t.test(x, y, paired = TRUE)` |
| F検定 | 2群の分散の比較 | `var.test(y ~ group, data)` |
